{% extends "base.html" %}
{% block content %}

{% set period_safe = period|default('all') %}
{% set semester_filter_safe = semester_filter|default('all') %}
{% set semester_stats_safe = semester_stats|default({'semester_1_avg': 0, 'semester_2_avg': 0, 'course_avg': 0}) %}
{% set page_safe = page|default(1) %}
{% set subject_pages_safe = subject_pages|default(1) %}
{% set subject_grade_rows_safe = subject_grade_rows|default([]) %}

<h1 class="page-title">Кабинет студента</h1>

<div class="dashboard-actions">
    <a href="{{ url_for('export_student_grades') }}" class="btn">Скачать мои оценки (CSV)</a>
</div>

<div class="card-grid">
    <div class="card"><div class="card-title">Группа</div><div class="card-value">{{ group_name }}</div></div>
    <div class="card"><div class="card-title">Средний балл (по фильтру)</div><div class="card-value">{{ average_grade }}</div></div>
    <div class="card"><div class="card-title">Предметы</div><div class="card-value">{{ subject_count }}</div></div>
    <div class="card"><div class="card-title">Лучшая оценка</div><div class="card-value">{{ best_grade }}</div></div>
    <div class="card"><div class="card-title">Минимальная оценка</div><div class="card-value">{{ worst_grade }}</div></div>
    <div class="card"><div class="card-title">Средний за 1 семестр</div><div class="card-value">{{ semester_stats_safe.semester_1_avg }}</div></div>
    <div class="card"><div class="card-title">Средний за 2 семестр</div><div class="card-value">{{ semester_stats_safe.semester_2_avg }}</div></div>
    <div class="card"><div class="card-title">Средний за курс</div><div class="card-value">{{ semester_stats_safe.course_avg }}</div></div>
    <div class="card"><div class="card-title">Новых оценок за 7 дней</div><div class="card-value">{{ new_grades_count|default(0) }}</div></div>
    <div class="card"><div class="card-title">Статус успеваемости</div><div class="card-value">{{ risk_level|default('Низкий риск') }}</div></div>
</div>

<section class="card list-card student-grades">
    <h2>Динамика среднего балла</h2>
    {% if progress_points|default([]) %}
        <div class="progress-line" id="progress-line">
            {% for point in progress_points %}
                <div class="progress-point" style="left: {{ ((loop.index0 / ((progress_points|length - 1) if progress_points|length > 1 else 1)) * 100)|round(2) }}%;">
                    <span class="progress-value">{{ point.avg }}</span>
                    <span class="progress-label">{{ point.label }}</span>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="muted-text">Пока недостаточно данных для динамики.</p>
    {% endif %}
</section>

<section class="card list-card student-grades">
    <h2>Успеваемость по предметам</h2>

    <form method="GET" style="display:flex;gap:10px;align-items:end;flex-wrap:wrap;margin-bottom:10px;">
        <div>
            <label class="field-label" for="period">Период</label>
            <select id="period" name="period" class="input-field" style="margin:0;min-width:160px;">
                <option value="all" {% if period_safe == 'all' %}selected{% endif %}>За всё время</option>
                <option value="month" {% if period_safe == 'month' %}selected{% endif %}>Последний месяц</option>
                <option value="week" {% if period_safe == 'week' %}selected{% endif %}>Последняя неделя</option>
            </select>
        </div>
        <div>
            <label class="field-label" for="semester">Семестр</label>
            <select id="semester" name="semester" class="input-field" style="margin:0;min-width:160px;">
                <option value="all" {% if semester_filter_safe == 'all' %}selected{% endif %}>Оба семестра</option>
                <option value="1" {% if semester_filter_safe == '1' %}selected{% endif %}>1 семестр</option>
                <option value="2" {% if semester_filter_safe == '2' %}selected{% endif %}>2 семестр</option>
            </select>
        </div>
        <button class="btn" type="submit">Применить</button>
    </form>

    <input type="text" id="student-grade-search" class="input-field" placeholder="Поиск по предмету/оценке/комментарию/дате">

    {% if subject_grade_rows_safe %}
    <div class="table-wrap">
        <table class="grade-table" id="student-grade-table">
            <thead><tr><th>Предмет</th><th>Оценки (дата сверху)</th><th>Средний балл</th></tr></thead>
            <tbody>
                {% for row in subject_grade_rows_safe %}
                <tr>
                    <td>{{ row.subject_name }}</td>
                    <td>
                        <div class="grade-strip">
                            {% for item in row.grades %}
                                <div class="grade-chip" title="{{ item.comment or 'Без комментария' }}">
                                    <div class="grade-date">{{ item.graded_at.strftime('%d.%m') if item.graded_at else '—' }}</div>
                                    <div class="grade-number">{{ item.grade }}</div>
                                    <div class="grade-comment">Семестр {{ item.semester }}</div>
                                    {% if item.comment %}<div class="grade-comment">{{ item.comment }}</div>{% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </td>
                    <td><span class="badge">{{ row.avg }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <p class="muted-text">Оценок пока нет.</p>
    {% endif %}

    {% if subject_pages_safe > 1 %}
    <div class="pager">
        {% for p in range(1, subject_pages_safe + 1) %}
            <a class="pager-link{% if p == page_safe %} active{% endif %}" href="{{ url_for('student_dashboard', period=period_safe, semester=semester_filter_safe, page=p) }}">{{ p }}</a>
        {% endfor %}
    </div>
    {% endif %}
</section>

<script>
const studentSearch = document.getElementById('student-grade-search');
const studentTable = document.getElementById('student-grade-table');
if (studentSearch && studentTable) {
    studentSearch.addEventListener('input', () => {
        const query = studentSearch.value.toLowerCase().trim();
        const rows = studentTable.querySelectorAll('tbody tr');
        rows.forEach((row) => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(query) ? '' : 'none';
        });
    });
}
</script>

{% endblock %}

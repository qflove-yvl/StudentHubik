{% extends "base.html" %}
{% block content %}

<h1 class="page-title">Кабинет студента</h1>

<div class="dashboard-actions">
    <a href="{{ url_for('export_student_grades') }}" class="btn">Скачать мои оценки (CSV)</a>
</div>

<div class="card-grid">
    <div class="card">
        <div class="card-title">Группа</div>
        <div class="card-value">{{ group_name }}</div>
    </div>

    <div class="card">
        <div class="card-title">Средний балл (общий)</div>
        <div class="card-value">{{ average_grade }}</div>
    </div>

    <div class="card">
        <div class="card-title">Предметы</div>
        <div class="card-value">{{ subject_count }}</div>
    </div>

    <div class="card">
        <div class="card-title">Лучшая оценка</div>
        <div class="card-value">{{ best_grade }}</div>
    </div>

    <div class="card">
        <div class="card-title">Минимальная оценка</div>
        <div class="card-value">{{ worst_grade }}</div>
    </div>
</div>

<section class="card list-card student-grades">
    <h2>Успеваемость по предметам</h2>

    
    <form method="GET" style="display:flex;gap:10px;align-items:end;flex-wrap:wrap;margin-bottom:10px;">
        <div>
            <label class="field-label" for="period">Период</label>
            <select id="period" name="period" class="input-field" style="margin:0;min-width:160px;">
                <option value="all" {% if period == 'all' %}selected{% endif %}>За всё время</option>
                <option value="month" {% if period == 'month' %}selected{% endif %}>Последний месяц</option>
                <option value="week" {% if period == 'week' %}selected{% endif %}>Последняя неделя</option>
            </select>
        </div>
        <button class="btn" type="submit">Применить</button>
    </form>

    <input type="text" id="student-grade-search" class="input-field" placeholder="Поиск по предмету/оценке/комментарию/дате">

    {% if subject_grade_rows %}
    <div class="table-wrap">
        <table class="grade-table" id="student-grade-table">
            <thead>
                <tr>
                    <th>Предмет</th>
                    <th>Оценки (дата сверху)</th>
                    <th>Средний балл</th>
                </tr>
            </thead>
            <tbody>
                {% for row in subject_grade_rows %}
                <tr>
                    <td>{{ row.subject_name }}</td>
                    <td>
                        <div class="grade-strip">
                            {% for item in row.grades %}
                                <div class="grade-chip" title="{{ item.comment or 'Без комментария' }}">
                                    <div class="grade-date">{{ item.graded_at.strftime('%d.%m') if item.graded_at else '—' }}</div>
                                    <div class="grade-number">{{ item.grade }}</div>
                                    {% if item.comment %}
                                        <div class="grade-comment">{{ item.comment }}</div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </td>
                    <td><span class="badge">{{ row.avg }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <p class="muted-text">Оценок пока нет.</p>
    {% endif %}
    {% if subject_pages > 1 %}
    <div class="pager">
        {% for p in range(1, subject_pages + 1) %}
            <a class="pager-link{% if p == page %} active{% endif %}" href="{{ url_for('student_dashboard', period=period, page=p) }}">{{ p }}</a>
        {% endfor %}
    </div>
    {% endif %}

</section>

<script>
const studentSearch = document.getElementById('student-grade-search');
const studentTable = document.getElementById('student-grade-table');

if (studentSearch && studentTable) {
    studentSearch.addEventListener('input', () => {
        const query = studentSearch.value.toLowerCase().trim();
        const rows = studentTable.querySelectorAll('tbody tr');

        rows.forEach((row) => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(query) ? '' : 'none';
        });
    });
}
</script>

{% endblock %}

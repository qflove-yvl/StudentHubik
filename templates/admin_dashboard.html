{% extends "base.html" %}
{% block content %}

{% set page_safe = page|default(1) %}
{% set total_pages_safe = total_pages|default(1) %}
{% set query_safe = query|default('') %}
{% set role_filter_safe = role_filter|default('all') %}
{% set status_filter_safe = status_filter|default('pending') %}
{% set group_filter_safe = group_filter|default('all') %}
{% set can_manage_safe = can_manage|default(false) %}

<h1 class="page-title">Админ-панель</h1>
{% if not can_manage_safe %}<p class="muted-text" style="margin-bottom:12px;">Режим куратора: доступ только для просмотра.</p>{% endif %}

<div class="dashboard-actions">
    <a href="{{ url_for('export_all_users') }}" class="btn">Экспорт всех пользователей (CSV)</a>
    {% if can_manage_safe %}<a href="{{ url_for('admin_backup_db') }}" class="btn" style="margin-left:8px;">Скачать бэкап БД</a>{% endif %}
</div>

{% if total_pages_safe > 1 %}<div class="pager" style="margin-bottom:12px;">{% for p in range(1, total_pages_safe + 1) %}<a class="pager-link{% if p == page_safe %} active{% endif %}" href="{{ url_for('admin_dashboard', q=query_safe, role=role_filter_safe, status=status_filter_safe, group_id=group_filter_safe, page=p) }}">{{ p }}</a>{% endfor %}</div>{% endif %}



<section class="card" style="margin-bottom:24px;">
    <h2 style="margin-bottom:14px;">Расписание колледжа</h2>
    {% if latest_schedule %}
        <p class="muted-text" style="margin-bottom:10px;">Текущий файл: <strong>{{ latest_schedule.original_name }}</strong> ({{ latest_schedule.uploaded_at.strftime('%d.%m.%Y %H:%M') }})</p>
        <a href="{{ url_for('download_schedule', file_id=latest_schedule.id) }}" class="btn" style="margin-bottom:12px;">Скачать текущее расписание</a>
    {% else %}
        <p class="muted-text" style="margin-bottom:10px;">Расписание ещё не загружено.</p>
    {% endif %}

    {% if can_manage_safe %}
    <form method="POST" action="{{ url_for('admin_upload_schedule') }}" enctype="multipart/form-data" style="max-width:520px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <label class="field-label" for="schedule_file">Загрузить файл расписания (PDF/XLSX/DOCX)</label>
        <input id="schedule_file" type="file" name="schedule_file" class="input-field" required>
        <button class="btn" type="submit">Обновить расписание</button>
    </form>
    {% endif %}
</section>

<section class="card" style="margin-bottom:24px;">
    <h2 style="margin-bottom:14px;">Поиск и фильтры</h2>
    <form method="GET" action="{{ url_for('admin_dashboard') }}" class="grade-form">
        <label class="field-label" for="q">Поиск по ФИО / email</label>
        <input id="q" type="text" name="q" class="input-field" value="{{ query_safe }}" placeholder="Введите ФИО или email">

        <label class="field-label" for="role">Роль</label>
        <select id="role" name="role" class="input-field">
            <option value="all" {% if role_filter_safe == 'all' %}selected{% endif %}>Все</option>
            <option value="student" {% if role_filter_safe == 'student' %}selected{% endif %}>Студенты</option>
            <option value="teacher" {% if role_filter_safe == 'teacher' %}selected{% endif %}>Преподаватели</option>
        </select>

        <label class="field-label" for="status">Статус заявки</label>
        <select id="status" name="status" class="input-field">
            <option value="pending" {% if status_filter_safe == 'pending' %}selected{% endif %}>Ожидают одобрения</option>
            <option value="approved" {% if status_filter_safe == 'approved' %}selected{% endif %}>Одобренные</option>
            <option value="all" {% if status_filter_safe == 'all' %}selected{% endif %}>Все</option>
        </select>

        <label class="field-label" for="group_id">Группа (для студентов)</label>
        <select id="group_id" name="group_id" class="input-field">
            <option value="all" {% if group_filter_safe == 'all' %}selected{% endif %}>Все группы</option>
            {% for group in all_groups %}
            <option value="{{ group.id }}" {% if group_filter_safe == group.id|string %}selected{% endif %}>{{ group.name }}</option>
            {% endfor %}
        </select>

        <button class="btn" type="submit">Применить фильтры</button>
    </form>
</section>

{% set persist = {'q': query_safe, 'role': role_filter_safe, 'status': status_filter_safe, 'group_id': group_filter_safe} %}

<div class="card-grid">
    <div class="card"><div class="card-title">Новые студенты</div><div class="card-value">{{ pending_students|length }}</div></div>
    <div class="card"><div class="card-title">Новые преподаватели</div><div class="card-value">{{ pending_teachers|length }}</div></div>
    <div class="card"><div class="card-title">Одобренных студентов</div><div class="card-value">{{ approved_students|length }}</div></div>
    <div class="card"><div class="card-title">Одобренных преподавателей</div><div class="card-value">{{ approved_teachers|length }}</div></div>
</div>

<section class="card" style="margin-bottom:24px;">
    <h2 style="margin-bottom:14px;">Управление группами</h2>
    <form method="POST" action="{{ url_for('admin_add_group') }}" style="margin-bottom:14px;max-width:500px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="text" name="group_name" class="input-field" placeholder="Новая группа (например ИС24-01/2)" required>
        {% if can_manage_safe %}<button class="btn" type="submit">Добавить группу</button>{% endif %}
    </form>

    {% if all_groups %}
        <div class="table-wrap">
            <table class="grade-table">
                <thead><tr><th>Группа</th><th>Действие</th></tr></thead>
                <tbody>
                    {% for group in all_groups %}
                    <tr>
                        <td>{{ group.name }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('admin_delete_group', group_id=group.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                {% if can_manage_safe %}<button class="btn" type="submit" style="background:linear-gradient(90deg,#b91c1c,#ef4444);">Удалить</button>{% endif %}
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}
</section>

<section class="card" style="margin-bottom:24px;">
    <h2 style="margin-bottom:14px;">Заявки студентов</h2>
    {% if pending_students and can_manage_safe %}
        <form method="POST" action="{{ url_for('admin_bulk_user_action') }}" style="margin-bottom: 12px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="hidden" name="q" value="{{ persist.q }}">
            <input type="hidden" name="role" value="{{ persist.role }}">
            <input type="hidden" name="status" value="{{ persist.status }}">
            <input type="hidden" name="group_id" value="{{ persist.group_id }}">
            <div style="display:flex; gap:8px; flex-wrap: wrap; margin-bottom: 10px;">
                <button class="btn" type="submit" name="bulk_action" value="approve">Одобрить выбранные</button>
                <button class="btn" type="submit" name="bulk_action" value="reject" style="background:linear-gradient(90deg,#b91c1c,#ef4444);">Отклонить выбранные</button>
            </div>
            <div class="table-wrap">
                <table class="grade-table">
                    <thead><tr><th><input type="checkbox" id="select-all-students"></th><th>ФИО</th><th>Email</th><th>Группа</th></tr></thead>
                    <tbody>
                        {% for user in pending_students %}
                        <tr>
                            <td><input type="checkbox" class="pending-student-checkbox" name="selected_user_ids" value="{{ user.id }}"></td>
                            <td>{{ user.name }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ groups_by_id.get(user.group_id, '—') if user.group_id else '—' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
    {% else %}
        <p class="muted-text">Нет новых заявок студентов.</p>
    {% endif %}
</section>

<section class="card" style="margin-bottom:24px;">
    <h2 style="margin-bottom:14px;">Заявки преподавателей</h2>
    {% if pending_teachers and can_manage_safe %}
        <form method="POST" action="{{ url_for('admin_bulk_user_action') }}" style="margin-bottom: 12px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="hidden" name="q" value="{{ persist.q }}">
            <input type="hidden" name="role" value="{{ persist.role }}">
            <input type="hidden" name="status" value="{{ persist.status }}">
            <input type="hidden" name="group_id" value="{{ persist.group_id }}">
            <div style="display:flex; gap:8px; flex-wrap: wrap; margin-bottom: 10px;">
                <button class="btn" type="submit" name="bulk_action" value="approve">Одобрить выбранные</button>
                <button class="btn" type="submit" name="bulk_action" value="reject" style="background:linear-gradient(90deg,#b91c1c,#ef4444);">Отклонить выбранные</button>
            </div>
            <div class="table-wrap">
                <table class="grade-table">
                    <thead><tr><th><input type="checkbox" id="select-all-teachers"></th><th>ФИО</th><th>Email</th></tr></thead>
                    <tbody>
                        {% for user in pending_teachers %}
                        <tr>
                            <td><input type="checkbox" class="pending-teacher-checkbox" name="selected_user_ids" value="{{ user.id }}"></td>
                            <td>{{ user.name }}</td>
                            <td>{{ user.email }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
    {% else %}
        <p class="muted-text">Нет новых заявок преподавателей.</p>
    {% endif %}
</section>

<section class="card" style="margin-bottom:24px;">
    <h2 style="margin-bottom:14px;">Одобренные преподаватели: предметы под контролем админа</h2>
    {% for teacher in approved_teachers %}
        <div class="card" style="margin-bottom:14px;padding:18px;">
            <h3 style="margin-bottom:8px;">{{ teacher.name }} ({{ teacher.email }})</h3>
            <form method="POST" action="{{ url_for('admin_add_subject_for_teacher', teacher_id=teacher.id) }}" style="max-width:500px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="text" name="subject_name" class="input-field" placeholder="Добавить предмет преподавателю" required>
                <button class="btn" type="submit">Добавить предмет</button>
            </form>
        </div>
    {% endfor %}

    {% if all_subjects %}
        <div class="table-wrap">
            <table class="grade-table">
                <thead><tr><th>Предмет</th><th>ID препода</th><th>Действие</th></tr></thead>
                <tbody>
                    {% for subject in all_subjects %}
                    <tr>
                        <td>{{ subject.name }}</td>
                        <td>{{ subject.teacher_id }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('admin_delete_subject', subject_id=subject.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                <button class="btn" type="submit" style="background:linear-gradient(90deg,#b91c1c,#ef4444);">Удалить предмет</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}
</section>

<section class="card" style="margin-bottom:24px;">
    <h2 style="margin-bottom:14px;">Все одобренные студенты (с удалением аккаунта)</h2>
    {% if approved_students %}
        <div class="table-wrap">
            <table class="grade-table">
                <thead><tr><th>ФИО</th><th>Email</th><th>Группа</th><th>Действие</th></tr></thead>
                <tbody>
                    {% for student in approved_students %}
                    <tr>
                        <td>{{ student.name }}</td>
                        <td>{{ student.email }}</td>
                        <td>{{ groups_by_id.get(student.group_id, '—') if student.group_id else '—' }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('admin_delete_student', user_id=student.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                <button class="btn" type="submit" style="background:linear-gradient(90deg,#b91c1c,#ef4444);">Удалить аккаунт</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="muted-text">Пока нет одобренных студентов.</p>
    {% endif %}
</section>

<section class="card" style="margin-top:24px;">
    <h2 style="margin-bottom:14px;">Журнал действий (аудит)</h2>
    {% if recent_audit %}
    <div class="table-wrap">
        <table class="grade-table">
            <thead><tr><th>ID</th><th>Кто</th><th>Действие</th><th>Детали</th></tr></thead>
            <tbody>
                {% for item in recent_audit %}
                <tr>
                    <td>{{ item.id }}</td>
                    <td>{{ item.actor.name if item.actor else 'Система/Гость' }}</td>
                    <td>{{ item.action }}</td>
                    <td>{{ item.details }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <p class="muted-text">Логов пока нет.</p>
    {% endif %}
</section>

<section class="card" style="margin-top:24px;">
    <h2 style="margin-bottom:14px;">Все одобренные преподаватели</h2>
    {% if approved_teachers %}
    <div class="table-wrap">
        <table class="grade-table">
            <thead><tr><th>ФИО</th><th>Email</th><th>Telegram</th></tr></thead>
            <tbody>
            {% for teacher in approved_teachers %}
                <tr><td>{{ teacher.name }}</td><td>{{ teacher.email }}</td><td>{{ teacher.telegram or '—' }}</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="muted-text">Нет одобренных преподавателей.</p>
    {% endif %}
</section>

<script>
function toggleAll(masterId, itemsSelector) {
    const master = document.getElementById(masterId);
    if (!master) return;
    master.addEventListener('change', () => {
        document.querySelectorAll(itemsSelector).forEach((item) => {
            item.checked = master.checked;
        });
    });
}

toggleAll('select-all-students', '.pending-student-checkbox');
toggleAll('select-all-teachers', '.pending-teacher-checkbox');
</script>

{% endblock %}

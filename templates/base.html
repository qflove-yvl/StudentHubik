<!DOCTYPE html>
{% set _ui = ui_settings|default({'theme': 'dark', 'compact': 'off', 'animations': 'on'}) %}
{% set _csrf = csrf_token|default('') %}
<html lang="ru" data-theme="{{ _ui.theme|default('dark') }}" data-compact="{{ _ui.compact|default('off') }}" data-animations="{{ _ui.animations|default('on') }}">
<head>
<meta charset="UTF-8">
<title>StudentHubik</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<script>
const APP_CSRF_TOKEN = {{ _csrf|tojson }};
(function() {
  try {
    var theme = localStorage.getItem('studenthubik_theme') || {{ _ui.theme|default('dark')|tojson }};
    var compact = localStorage.getItem('studenthubik_compact') || {{ _ui.compact|default('off')|tojson }};
    var animations = localStorage.getItem('studenthubik_animations') || {{ _ui.animations|default('on')|tojson }};
    document.documentElement.setAttribute('data-theme', theme);
    document.documentElement.setAttribute('data-compact', compact);
    document.documentElement.setAttribute('data-animations', animations);
  } catch (e) {}
})();
</script>
</head>
<body>

<div class="topbar">
    <div class="top-left">
        <img src="{{ url_for('static', filename='logo.svg') }}" class="top-logo" alt="StudentHubik">
    </div>

    {% if current_user.is_authenticated %}
    <div class="top-right">
        <div class="user-avatar">{{ (current_user.name[:1] or '?')|upper }}</div>
        <span class="username">{{ current_user.name }}</span>
        <a href="{{ url_for('logout') }}" class="logout-btn">Выйти</a>
    </div>
    {% endif %}
</div>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="flash-wrapper">
      {% for message in messages %}
        <div class="flash-message">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="app-container">

    {% if current_user.is_authenticated %}
    <aside class="sidebar">
        <a href="{{ url_for('dashboard') }}" class="nav-link{% if request.endpoint == 'dashboard' %} active{% endif %}">Панель</a>
        <a href="{{ url_for('profile') }}" class="nav-link{% if request.endpoint == 'profile' %} active{% endif %}">Профиль</a>
        <a href="/settings" class="nav-link{% if request.endpoint == 'settings' %} active{% endif %}">Настройки</a>
        <a href="{{ url_for('support') }}" class="nav-link{% if request.endpoint == 'support' %} active{% endif %}">Помощь и поддержка</a>
        {% if current_user.role == 'student' %}
            <a href="{{ url_for('student_dashboard') }}" class="nav-link{% if request.endpoint == 'student_dashboard' %} active{% endif %}">Мои оценки</a>
            <a href="{{ url_for('export_student_grades') }}" class="nav-link">Экспорт оценок</a>
        {% elif current_user.role == 'teacher' %}
            <a href="{{ url_for('teacher_dashboard') }}" class="nav-link{% if request.endpoint == 'teacher_dashboard' %} active{% endif %}">Кабинет преподавателя</a>
            <a href="{{ url_for('export_teacher_grades') }}" class="nav-link">Экспорт оценок</a>
        {% elif current_user.role in ['admin', 'curator'] %}
            <a href="{{ url_for('admin_dashboard') }}" class="nav-link{% if request.endpoint == 'admin_dashboard' %} active{% endif %}">Админ-панель</a>
        {% endif %}
    </aside>
    {% endif %}

    <main class="main-content{% if not current_user.is_authenticated %} no-sidebar{% endif %}">
        {% block content %}{% endblock %}
    </main>

</div>


<script>
(function () {
  const forms = document.querySelectorAll('form');
  forms.forEach((form) => {
    const method = (form.getAttribute('method') || 'GET').toUpperCase();
    if (method !== 'POST') return;
    if (form.querySelector('input[name="csrf_token"]')) return;
    if (!APP_CSRF_TOKEN) return;
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'csrf_token';
    input.value = APP_CSRF_TOKEN;
    form.appendChild(input);
  });
})();
</script>

</body>
</html>

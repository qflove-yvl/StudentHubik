{% extends "base.html" %}
{% block content %}

<h1 class="page-title">Кабинет преподавателя</h1>

<div class="card-grid">
    <div class="card">
        <div class="card-title">Предметов</div>
        <div class="card-value">{{ subjects|length }}</div>
    </div>

    <div class="card">
        <div class="card-title">Студентов</div>
        <div class="card-value">{{ students|length }}</div>
    </div>

    <div class="card">
        <div class="card-title">Последних оценок</div>
        <div class="card-value">{{ recent_grades|length }}</div>
    </div>
</div>

<div class="panel-grid">
    <section class="card form-card">
        <h2>Выставить оценку</h2>

        {% if not subjects %}
            <p class="muted-text">У вас пока нет предметов. Добавьте предмет в БД и попробуйте снова.</p>
        {% else %}
            <form method="POST" class="grade-form">
                <label class="field-label" for="student_id">Студент</label>
                <select name="student_id" id="student_id" class="input-field select-highlight" required>
                    <option value="" disabled selected>Выберите студента</option>
                    {% for student in students %}
                        <option value="{{ student.id }}">{{ student.name }}{% if student.group_id %} · Группа {{ student.group_id }}{% endif %}</option>
                    {% endfor %}
                </select>

                <label class="field-label" for="subject_id">Предмет</label>
                <select name="subject_id" id="subject_id" class="input-field" required>
                    <option value="" disabled selected>Выберите предмет</option>
                    {% for subject in subjects %}
                        <option value="{{ subject.id }}">{{ subject.name }}</option>
                    {% endfor %}
                </select>

                <label class="field-label" for="value">Оценка</label>
                <input type="number" min="1" max="5" name="value" id="value" class="input-field" required>

                <button type="submit" class="btn">Сохранить</button>
                <p class="muted-text hint-text">Если оценка по предмету уже была — она обновится.</p>
            </form>
        {% endif %}
    </section>

    <section class="card list-card">
        <h2>Последние оценки</h2>

        <input type="text" id="grade-search" class="input-field" placeholder="Быстрый поиск по студенту/предмету">

        {% if recent_grades %}
        <div class="table-wrap">
            <table class="grade-table" id="grade-table">
                <thead>
                    <tr>
                        <th>Студент</th>
                        <th>Предмет</th>
                        <th>Оценка</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in recent_grades %}
                    <tr>
                        <td>{{ item.student.name }}</td>
                        <td>{{ item.subject.name }}</td>
                        <td><span class="badge">{{ item.grade }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
            <p class="muted-text">Пока оценок нет.</p>
        {% endif %}
    </section>
</div>

<script>
const searchInput = document.getElementById('grade-search');
const gradeTable = document.getElementById('grade-table');

if (searchInput && gradeTable) {
    searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase().trim();
        const rows = gradeTable.querySelectorAll('tbody tr');

        rows.forEach((row) => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(query) ? '' : 'none';
        });
    });
}
</script>

{% endblock %}

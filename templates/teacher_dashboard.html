{% extends "base.html" %}
{% block content %}

{% set period_safe = period|default('all') %}
{% set semester_filter_safe = semester_filter|default('all') %}
{% set page_safe = page|default(1) %}
{% set total_pages_safe = total_pages|default(1) %}
{% set search_query_safe = search_query|default('') %}
{% set teacher_stats_safe = teacher_stats|default({'semester_1_avg':0,'semester_2_avg':0,'course_avg':0}) %}

<h1 class="page-title">Кабинет преподавателя</h1>

<div class="dashboard-actions">
    <a href="{{ url_for('export_teacher_grades') }}" class="btn">Скачать оценки (CSV)</a>
</div>

<section class="card" style="margin-bottom:24px;">
    <h2 style="margin-bottom:12px;">Назначенные вам предметы</h2>
    {% if subjects %}
        <div class="subject-tags">{% for subject in subjects %}<span class="subject-tag">{{ subject.name }}</span>{% endfor %}</div>
    {% else %}
        <p class="muted-text">Админ пока не назначил вам предметы.</p>
    {% endif %}
</section>

<div class="card-grid">
    <div class="card"><div class="card-title">Предметов</div><div class="card-value">{{ subjects|length }}</div></div>
    <div class="card"><div class="card-title">Студентов</div><div class="card-value">{{ students|length }}</div></div>
    <div class="card"><div class="card-title">Оценок (страница)</div><div class="card-value">{{ recent_grades|length }}</div></div>
    <div class="card"><div class="card-title">Средний за 1 семестр</div><div class="card-value">{{ teacher_stats_safe.semester_1_avg }}</div></div>
    <div class="card"><div class="card-title">Средний за 2 семестр</div><div class="card-value">{{ teacher_stats_safe.semester_2_avg }}</div></div>
    <div class="card"><div class="card-title">Средний за курс</div><div class="card-value">{{ teacher_stats_safe.course_avg }}</div></div>
</div>

<div class="panel-grid">
    <section class="card form-card">
        <h2>Выставить новую оценку</h2>
        {% if not subjects %}
            <p class="muted-text">Нет доступных предметов. Обратитесь к администратору.</p>
        {% else %}
            <form method="POST" class="grade-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="action" value="create_grade">

                <label class="field-label" for="student_id">Студент</label>
                <select name="student_id" id="student_id" class="input-field select-highlight" required>
                    <option value="" disabled selected>Выберите студента</option>
                    {% for student in students %}
                        <option value="{{ student.id }}">{{ student.name }}{% if student.group_id %} · Группа {{ groups_by_id.get(student.group_id, student.group_id) }}{% endif %}</option>
                    {% endfor %}
                </select>

                <label class="field-label" for="subject_id">Предмет</label>
                <select name="subject_id" id="subject_id" class="input-field" required>
                    <option value="" disabled selected>Выберите предмет</option>
                    {% for subject in subjects %}<option value="{{ subject.id }}">{{ subject.name }}</option>{% endfor %}
                </select>

                <label class="field-label" for="value">Оценка</label>
                <input type="number" min="1" max="5" name="value" id="value" class="input-field" required>

                <label class="field-label" for="semester_new">Семестр</label>
                <select name="semester" id="semester_new" class="input-field" required>
                    <option value="1">1 семестр</option>
                    <option value="2">2 семестр</option>
                </select>

                <label class="field-label" for="comment">Комментарий (необязательно)</label>
                <textarea name="comment" id="comment" class="input-field" rows="3" maxlength="300" placeholder="Например: контрольная, пересдача, активность на паре"></textarea>

                <button type="submit" class="btn">Добавить оценку</button>
                <p class="muted-text hint-text">Оценка сразу отправится студенту в уведомления.</p>
            </form>
        {% endif %}
        {% if total_pages_safe > 1 %}
        <div class="pager">
            {% for p in range(1, total_pages_safe + 1) %}
                <a class="pager-link{% if p == page_safe %} active{% endif %}" href="{{ url_for('teacher_dashboard', period=period_safe, semester=semester_filter_safe, q=search_query_safe, page=p) }}">{{ p }}</a>
            {% endfor %}
        </div>
        {% endif %}
    </section>

    <section class="card list-card">
        <h2>Последние оценки (редактирование и удаление)</h2>
        <form method="GET" style="display:flex;gap:10px;align-items:end;flex-wrap:wrap;margin-bottom:10px;">
            <div>
                <label class="field-label" for="q">Поиск</label>
                <input type="text" id="q" name="q" class="input-field" style="margin:0;min-width:220px;" value="{{ search_query_safe }}" placeholder="Студент / предмет / комментарий">
            </div>
            <div>
                <label class="field-label" for="period">Период</label>
                <select id="period" name="period" class="input-field" style="margin:0;min-width:160px;">
                    <option value="all" {% if period_safe == 'all' %}selected{% endif %}>За всё время</option>
                    <option value="month" {% if period_safe == 'month' %}selected{% endif %}>Последний месяц</option>
                    <option value="week" {% if period_safe == 'week' %}selected{% endif %}>Последняя неделя</option>
                </select>
            </div>
            <div>
                <label class="field-label" for="semester">Семестр</label>
                <select id="semester" name="semester" class="input-field" style="margin:0;min-width:160px;">
                    <option value="all" {% if semester_filter_safe == 'all' %}selected{% endif %}>Оба семестра</option>
                    <option value="1" {% if semester_filter_safe == '1' %}selected{% endif %}>1 семестр</option>
                    <option value="2" {% if semester_filter_safe == '2' %}selected{% endif %}>2 семестр</option>
                </select>
            </div>
            <button class="btn" type="submit">Фильтр</button>
        </form>

        <input type="text" id="grade-search" class="input-field" placeholder="Быстрый поиск по таблице">

        {% if recent_grades %}
        <div class="table-wrap">
            <table class="grade-table" id="grade-table">
                <thead><tr><th>Студент</th><th>Предмет</th><th>Оценка</th><th>Семестр</th><th>Комментарий</th><th>Выставлена</th><th>Действия</th></tr></thead>
                <tbody>
                    {% for item in recent_grades %}
                    <tr>
                        <td>{{ item.student.name }}</td>
                        <td>{{ item.subject.name }}</td>
                        <td><input type="number" min="1" max="5" name="value" form="update-grade-{{ item.id }}" class="input-field" style="margin:0;max-width:78px;" value="{{ item.grade }}" required></td>
                        <td>
                            <select name="semester" form="update-grade-{{ item.id }}" class="input-field" style="margin:0;max-width:130px;">
                                <option value="1" {% if item.semester == 1 %}selected{% endif %}>1</option>
                                <option value="2" {% if item.semester == 2 %}selected{% endif %}>2</option>
                            </select>
                        </td>
                        <td><input type="text" name="comment" form="update-grade-{{ item.id }}" class="input-field" style="margin:0;min-width:220px;" value="{{ item.comment or '' }}" maxlength="300" placeholder="Комментарий"></td>
                        <td>{{ item.graded_at.strftime('%d.%m.%Y %H:%M') if item.graded_at else '—' }}</td>
                        <td style="white-space:nowrap;">
                            <form id="update-grade-{{ item.id }}" method="POST" style="display:inline-block;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}"><input type="hidden" name="action" value="update_grade"><input type="hidden" name="grade_id" value="{{ item.id }}"><button class="btn" type="submit">Сохранить</button>
                            </form>
                            <form method="POST" style="display:inline-block;margin-top:6px;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}"><input type="hidden" name="action" value="delete_grade"><input type="hidden" name="grade_id" value="{{ item.id }}"><button class="btn" type="submit" style="background:linear-gradient(90deg,#b91c1c,#ef4444);">Удалить</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
            <p class="muted-text">Пока оценок нет.</p>
        {% endif %}
    </section>
</div>

<section class="card" style="margin-top:24px;">
    <h2>Средний балл по предметам</h2>
    {% if subjects %}
    <div class="table-wrap">
        <table class="grade-table">
            <thead><tr><th>Предмет</th><th>Средний балл</th></tr></thead>
            <tbody>
                {% for subject in subjects %}
                <tr><td>{{ subject.name }}</td><td><span class="badge">{{ subject_averages.get(subject.id, 0) or 0 }}</span></td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <p class="muted-text">Пока нет предметов для статистики.</p>
    {% endif %}
</section>

<script>
const gradeSearch = document.getElementById('grade-search');
const gradeTable = document.getElementById('grade-table');
if (gradeSearch && gradeTable) {
    gradeSearch.addEventListener('input', () => {
        const query = gradeSearch.value.toLowerCase().trim();
        const rows = gradeTable.querySelectorAll('tbody tr');
        rows.forEach((row) => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(query) ? '' : 'none';
        });
    });
}
</script>

{% endblock %}
